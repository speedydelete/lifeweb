<!DOCTYPE html>
<html>
    <head>
        <title>apgweb</title>
        <meta charset="utf-8">
        <style>

* {
    box-sizing: border-box;
}

html, body {
    position: absolute;
    inset: 0;
    height: 100%;
    width: 100%;
    font-family: 'Courier New', Courier, monospace;
}

body {
    padding: 20px;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
}

#config {
    display: flex;
    flex-direction: column;
    align-items: start;
    gap: 0.65em;
}

#config > div {
    display: flex;
    flex-direction: row;
    gap: 1ch;
    align-items: center;
}

h1 {
    text-align: center;
}

button, input:not([type=checkbox]) {
    padding: 3px 6px;
    font-family: inherit;
    font-size: inherit;
    background-color: inherit;
    color: inherit;
    border: 1px solid black;
}

input:focus {
    outline: none;
}

input[type=number] {
    appearance: textfield;
}

input::-webkit-inner-spin-button, input::-webkit-outer-spin-button {
    display: none;
}

input[type=checkbox] {
    height: 1.25em;
    width: 1.25em;
}

#rule {
    width: 30ch;
}

#symmetry {
    width: 26ch;
}

#key {
    width: 31ch;
}

#soups {
    width: 24ch;
}

#seed {
    width: 30ch;
}

#hauls {
    width: 24ch;
}

#verifies {
    width: 21ch;
}

#run {
    margin-top: 1.3em;
}

#out {
    min-width: 70ch;
    padding-bottom: 30px;
    font-size: 14px;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
}

a, a:visited {
    color: blue;
    text-decoration: underline;
    cursor: pointer;
}

#source {
    position: fixed;
    bottom: 30px;
    right: 30px;
}

        </style>
    </head>
    <body>
        <div id="config">
            <h1>apgweb</h1>
            <div>Rule: <input type="text" id="rule" value="b3s23" /></div>
            <div>Symmetry: <input type="text" id="symmetry" value="C1" /></div>
            <!-- <div>Key: <input type="text" id="key" /></div> -->
            <div>Soups/haul: <input type="number" id="soups" value="10" /></div>
            <!-- <div>Haul limit: <input type="number" id="hauls" /></div> -->
            <div>Seed: <input type="text" id="seed" /></div>
            <!-- <div>Verifies/haul: <input type="number" id="verifies" value="1" /></div> -->
            <!-- <div>Upload to Catagolue: <input type="checkbox" id="upload" checked="true" /></div> -->
            <button id="run">Run</button>
        </div>
        <div id="out"></div>
        <div id="source"><a href="https://github.com/speedydelete/lifeweb">Source code</a></div>
        <script>'use strict';function printError(e){let x=String(e instanceof Error?('stack' in e?e.stack:e):e).replaceAll(/file:\/\/\/media\/fuse\/drivefs-[0-9a-f]+\/root\/code\//g,'').replaceAll('about:srcdoc','index.js');if(e instanceof Error&&!x.includes('Error'))x=String(e)+'\n'+x;for (let m of x.matchAll(/data:text\/javascript;base64,([a-zA-Z0-9+/=]+)/g)){let f=atob(m[1]);x=x.replaceAll(m[0],f.slice(2,f.indexOf('*/')))}if(document.readyState!=='complete'){alert(x);return;}let t=document.createElement('div');t.textContent='\n\n'+x;t.style.color='red';document.getElementById('out').appendChild(t);document.getElementById('config').style.display='none';let l=setInterval(()=>{});for(let i=1;i<=l;i++)clearInterval(i);l=requestAnimationFrame(()=>{});for(let i=1;i<=l;i++)cancelAnimationFrame(i);}window.addEventListener('error',e=>{printError(e.error);return true;});window.addEventListener('unhandledrejection',e=>{e.preventDefault();printError(e.reason);});</script>
        <script type="module">

import {soupSearch, toCatagolueRule, MAPPattern, getHashsoup, createPattern} from './lib/index.js';

const APGCODE_REGEX = /(x[spq]|yl)\d+_[a-z0-9]+/g;
const SOUP_REGEX = /k_[a-zA-Z0-9]+/g;

document.getElementById('run').addEventListener('click', async () => {
   document.getElementById('config').style.display = 'none';
    let elt = document.getElementById('out');
    let rule = toCatagolueRule(document.getElementById('rule').value);
    let symmetry = document.getElementById('symmetry').value;
    let soups = parseInt(document.getElementById('soups').value);
    if (Number.isNaN(soups)) {
        throw new Error('Invalid soups value');
    }
    let seed = document.getElementById('seed').value;
    if (!seed) {
        seed = undefined;
    }
    let data = await soupSearch({rule, symmetry, soups, seed, print(msg) {
        if (msg.includes('\x1b')) {
            msg = msg.replaceAll('\x1b[1;31m', ''/*'<span style="color: #ff7f7f">'*/);
            msg = msg.replaceAll('\x1b[1;34m', ''/*'<span style="color: #7f7fff">'*/);
            msg = msg.replaceAll('\x1b[1;32m', ''/*'<span style="color: #7fff7f">'*/);
            msg = msg.replaceAll('\x1b[0m', ''/*'</span>'*/);
        }
        for (let [match] of msg.matchAll(APGCODE_REGEX)) {
            msg = msg.replace(match, `<a href="https://catagolue.hatsya.com/object/${match}/${rule}">${match}</a>`);
        }
        for (let [match] of msg.matchAll(SOUP_REGEX)) {
            msg = msg.replace(match, `<a href="https://catagolue.hatsya.com/hashsoup/${symmetry}/${match}/${rule}">${match}</a>`);

        }
        elt.innerHTML += '\n' + msg;
    }});
    elt.innerHTML += `\n\n@VERSION apgweb-v1.2\n@MD5 ${data.md5}\n@ROOT ${data.seed}\n@RULE ${data.rule}\n@SYMMETRY ${data.symmetry}_web_test\n@NUM_SOUPS ${data.soups}\n@NUM_OBJECTS ${data.objects}\n\n@CENSUS TABLE\n${Object.entries(data.census).sort((a, b) => b[1] - a[1]).map(x => `<a href="https://catagolue.hatsya.com/object/${x[0]}/${rule}">${x[0]}</a> ${x[1]}`).join('\n')}\n\n@SAMPLE_SOUPIDS\n${Object.entries(data.samples).sort((a, b) => data.census[b[0]] - data.census[a[0]]).map(x => `<a href="https://catagolue.hatsya.com/object/${x[0]}/${rule}">${x[0]}</a> ${x[1].map(y => `<a href="https://catagolue.hatsya.com/hashsoup/${symmetry}/${data.seed}${y}/${rule}">${y}</a>`).join(' ')}`).join('\n')}\n\n\n<a id="download">Download</a>\n<a id="download-with-rles">Download with soup RLE's</a>`;
    let baseHaul = `@VERSION apgweb-v1.2\n@MD5 ${data.md5}\n@ROOT ${data.seed}\n@RULE ${data.rule}\n@SYMMETRY ${data.symmetry}_web_test\n@NUM_SOUPS ${data.soups}\n@NUM_OBJECTS ${data.objects}\n\n@CENSUS TABLE\n${Object.entries(data.census).sort((a, b) => b[1] - a[1]).map(x => x[0] + ' ' + x[1]).join('\n')}\n\n@SAMPLE_SOUPIDS\n`;
    let link = document.createElement('a');
    document.getElementById('download').addEventListener('click', event => {
        event.preventDefault();
        let haul = baseHaul + Object.entries(data.samples).sort((a, b) => data.census[b[0]] - data.census[a[0]]).map(x => x[0] + ' ' + x[1].join(' ')).join('\n');
        let url = URL.createObjectURL(new Blob([haul]));
        link.href = url;
        link.download = 'haul.apg';
        link.click();
    });
    document.getElementById('download-with-rles').addEventListener('click', async event => {
        event.preventDefault();
        let samples = Object.entries(data.samples).sort((a, b) => data.census[b[0]] - data.census[a[0]]);
        let haul = baseHaul;
        let seed = data.seed;
        for (let [apgcode, ids] of samples) {
            haul += '\n' + apgcode + '\n';
            let p = createPattern(rule);
            for (let id of ids) {
                let {height, width, data} = await getHashsoup(seed + id, symmetry);
                p.height = height;
                p.width = width;
                p.size = height * width;
                p.data = data;
                haul += p.toRLE() + '\n';
            }
        }
        let url = URL.createObjectURL(new Blob([haul]));
        link.href = url;
        link.download = 'haul.apg';
        link.click();
    });
});

document.querySelectorAll('input').forEach(elt => {
    let value = localStorage['apgweb-input-' + elt.id];
    if (value) {
        elt.value = value;
    }
    elt.addEventListener('change', () => {
        localStorage['apgweb-input-' + elt.id] = elt.value;
    });
});

        </script>
    </body>
</html>